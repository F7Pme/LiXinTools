<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电量查询系统</title>
    <link rel="icon" href="{{ url_for('static', filename='pic/app_icon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='pic/app_icon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="#"><i class="bi bi-lightning-charge-fill"></i> 电量查询系统</a>
                <span class="navbar-text text-white" id="latest-query-time">
                    最新查询时间: 加载中...
                </span>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <!-- 左侧面板：总体统计和楼栋统计 -->
                <div class="col-md-4">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> 总体统计</h5>
                        </div>
                        <div class="card-body" id="overall-stats">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>正在加载统计数据...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-building"></i> 楼栋统计</h5>
                        </div>
                        <div class="card-body" id="building-stats">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>正在加载楼栋数据...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> 查询历史</h5>
                        </div>
                        <div class="card-body" id="query-history">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>正在加载查询历史...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 数据分析移动到左侧 -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 数据分析</h5>
                        </div>
                        <div class="card-body" id="analysis-result">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p>正在加载分析结果...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧面板：房间列表 -->
                <div class="col-md-8">
                    <div class="card mb-4 shadow-sm">
                        <div
                            class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> 房间电量数据</h5>
                            <div class="d-flex align-items-center">
                                <!-- 历史电量查询选择器 -->
                                <div class="me-3 history-selector-container">
                                    <div class="input-group">
                                        <select id="history-selector" class="form-select form-select-sm">
                                            <option value="latest" selected>最新数据</option>
                                            <!-- 历史时间点将通过JavaScript动态加载 -->
                                        </select>
                                        <button class="btn btn-sm btn-outline-primary" id="apply-history-selector">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-group" style="max-width: 300px;">
                                    <input type="text" class="form-control" id="room-search" placeholder="搜索房间...">
                                    <button class="btn btn-light" type="button" id="search-button">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="sortable" data-field="building">楼栋 <i
                                                    class="bi bi-arrow-down-up"></i></th>
                                            <th class="sortable" data-field="room">房间号 <i
                                                    class="bi bi-arrow-down-up"></i></th>
                                            <th class="sortable" data-field="electricity">剩余电量(度) <i
                                                    class="bi bi-arrow-down-up"></i></th>
                                            <th class="sortable" data-field="status">状态 <i
                                                    class="bi bi-arrow-down-up"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="room-data">
                                        <tr>
                                            <td colspan="4" class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <p class="mt-3">正在加载房间数据...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-light py-3 mt-5">
            <div class="container text-center">
                <p class="mb-0">© 2025 电量查询系统 | Li Xin Tools</p>
                <p class="small text-muted mb-0 mt-1">作者: 顾佳俊 | 微信: AL-0729-zK | 邮箱: 3298732438@qq.com</p>
                <p class="small text-muted mb-1">上海立信会计金融学院 2023级金融科技5班</p>
                <p class="small text-muted mb-1"><a href="https://beian.miit.gov.cn/"
                        target="_blank">沪ICP备2025124588号-1</a></p>
                <!-- 调试按钮 -->
                <button id="debug-btn" class="btn btn-sm btn-outline-secondary mt-2">调试数据库</button>
                <!-- 临时调试按钮 -->
                <button id="test-api-btn" class="btn btn-sm btn-outline-info mt-2 ms-2">测试API</button>
                <button id="refresh-selector-btn" class="btn btn-sm btn-outline-success mt-2 ms-2">刷新选择器</button>

                <!-- API直接测试工具 -->
                <div class="card mt-2 border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">API测试工具</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label for="test-time-id" class="form-label">Time ID:</label>
                            <div class="input-group">
                                <input type="text" id="test-time-id" class="form-control form-control-sm"
                                    value="202505012230">
                                <button class="btn btn-sm btn-secondary" id="use-selector-value">使用选择器值</button>
                            </div>
                            <div class="form-text text-muted" id="current-selector-value">
                                当前选择器值: <span>latest</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <button id="test-direct-api" class="btn btn-sm btn-primary">直接测试API</button>
                            <button id="debug-selector" class="btn btn-sm btn-warning ms-2">调试选择器</button>
                        </div>
                        <div id="api-test-result" class="mt-2 small" style="max-height:150px;overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- 调试模态框 -->
    <div class="modal fade" id="debugModal" tabindex="-1" aria-labelledby="debugModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="debugModalLabel">数据库诊断信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center" id="debug-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p>正在获取数据库信息...</p>
                    </div>
                    <div id="debug-content" style="display: none;">
                        <div class="accordion" id="debugAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTables">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTables" aria-expanded="false"
                                        aria-controls="collapseTables">
                                        数据库表
                                    </button>
                                </h2>
                                <div id="collapseTables" class="accordion-collapse collapse"
                                    aria-labelledby="headingTables" data-bs-parent="#debugAccordion">
                                    <div class="accordion-body" id="tables-info">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingColumns">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseColumns" aria-expanded="false"
                                        aria-controls="collapseColumns">
                                        电量历史表结构
                                    </button>
                                </h2>
                                <div id="collapseColumns" class="accordion-collapse collapse"
                                    aria-labelledby="headingColumns" data-bs-parent="#debugAccordion">
                                    <div class="accordion-body" id="columns-info">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingQueries">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseQueries" aria-expanded="false"
                                        aria-controls="collapseQueries">
                                        查询历史
                                    </button>
                                </h2>
                                <div id="collapseQueries" class="accordion-collapse collapse"
                                    aria-labelledby="headingQueries" data-bs-parent="#debugAccordion">
                                    <div class="accordion-body" id="queries-info">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingData">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseData" aria-expanded="false"
                                        aria-controls="collapseData">
                                        示例数据
                                    </button>
                                </h2>
                                <div id="collapseData" class="accordion-collapse collapse" aria-labelledby="headingData"
                                    data-bs-parent="#debugAccordion">
                                    <div class="accordion-body" id="data-info">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingDiagnosis">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseDiagnosis" aria-expanded="true"
                                        aria-controls="collapseDiagnosis">
                                        问题诊断
                                    </button>
                                </h2>
                                <div id="collapseDiagnosis" class="accordion-collapse collapse show"
                                    aria-labelledby="headingDiagnosis" data-bs-parent="#debugAccordion">
                                    <div class="accordion-body" id="diagnosis-info">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="fix-data-btn">修复数据</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 宿舍历史电量模态框 -->
    <div class="modal fade" id="roomHistoryModal" tabindex="-1" aria-labelledby="roomHistoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roomHistoryModalLabel">宿舍历史电量数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center" id="room-history-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p>正在获取历史数据...</p>
                    </div>
                    <div id="room-history-content" style="display: none;">
                        <div class="room-info mb-3">
                            <h4 id="room-history-title">楼栋 - 房间号</h4>
                        </div>

                        <!-- 图表容器 -->
                        <div class="chart-container mb-4" style="position: relative; height:300px;">
                            <canvas id="electricityChart"></canvas>
                        </div>

                        <!-- 数据表格 -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>日期时间</th>
                                        <th>剩余电量(度)</th>
                                        <th>消耗电量(度)</th>
                                    </tr>
                                </thead>
                                <tbody id="room-history-data">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="room-history-error" class="alert alert-danger" style="display: none;">
                        获取数据时出错
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- 临时调试脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 添加一个独立的调试工具到页面
            const debugTools = document.createElement('div');
            debugTools.className = 'container mt-5 mb-5 p-3 border rounded';
            debugTools.style.backgroundColor = '#f8f9fa';
            debugTools.innerHTML = `
                <h4 class="text-center">API测试工具</h4>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">手动测试时间ID</label>
                            <div class="input-group">
                                <input type="text" id="test-time-id" class="form-control" placeholder="输入time_id (如: 202505012230)">
                                <button class="btn btn-outline-primary" id="test-time-id-btn">测试</button>
                            </div>
                            <div class="form-text">输入时间ID (格式: YYYYMMDDHHmm)，直接测试API返回结果</div>
                        </div>
                        <div id="api-test-result" class="border rounded p-3 mt-3" style="max-height: 300px; overflow-y: auto; display: none;">
                        </div>
                    </div>
                </div>
            `;

            // 插入到页面中
            document.body.insertBefore(debugTools, document.body.firstChild);

            // 添加测试按钮的事件
            document.getElementById('test-time-id-btn').addEventListener('click', async function () {
                const timeIdInput = document.getElementById('test-time-id');
                const timeId = timeIdInput.value.trim();

                if (!timeId) {
                    alert('请输入有效的时间ID');
                    return;
                }

                const resultDiv = document.getElementById('api-test-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                    <p class="text-center mt-2">正在请求API: /api/history_data/${timeId}...</p>
                `;

                try {
                    const response = await fetch(`/api/history_data/${timeId}`);
                    const data = await response.json();

                    // 格式化显示结果
                    const pre = document.createElement('pre');
                    pre.style.maxHeight = '250px';
                    pre.style.overflow = 'auto';
                    pre.innerHTML = JSON.stringify(data, null, 2);

                    // 更新结果
                    resultDiv.innerHTML = `
                        <h5>API响应结果</h5>
                        <div class="alert ${data.error ? 'alert-danger' : 'alert-success'}">
                            ${data.error ? `错误: ${data.error}` : `成功: 获取到 ${data.data ? data.data.length : 0} 条记录`}
                        </div>
                    `;
                    resultDiv.appendChild(pre);

                    // 添加到历史选择器中
                    if (!data.error && data.data && data.data.length > 0) {
                        const testDataButton = document.createElement('button');
                        testDataButton.className = 'btn btn-success mt-2';
                        testDataButton.textContent = '显示获取的数据';
                        testDataButton.addEventListener('click', function () {
                            // 存储数据用于搜索和排序
                            window.originalRoomData = data.data;

                            // 应用当前排序设置
                            const sortedData = sortRoomData([...window.originalRoomData]);

                            // 显示排序后的数据
                            displayRoomData(sortedData);

                            // 更新显示时间
                            updateDisplayTime(data.query_time || timeId, true);

                            // 关闭API测试结果
                            resultDiv.style.display = 'none';

                            // 滚动到顶部
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        });
                        resultDiv.appendChild(testDataButton);
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>请求出错</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            });

            // 为应用历史选择器按钮添加点击事件
            const applyHistorySelectorBtn = document.getElementById('apply-history-selector');
            if (applyHistorySelectorBtn) {
                applyHistorySelectorBtn.addEventListener('click', function () {
                    const historySelector = document.getElementById('history-selector');
                    if (historySelector) {
                        const selectedValue = historySelector.value;
                        console.log("应用历史选择器按钮被点击，选中的值:", selectedValue);

                        // 如果选择的是最新数据，则调用fetchElectricityData函数
                        if (selectedValue === 'latest') {
                            if (typeof window.fetchElectricityData === 'function') {
                                window.fetchElectricityData();
                            } else {
                                console.error("fetchElectricityData函数未定义");
                            }
                        }
                        // 否则，调用fetchHistoryData函数，传入选中的timeId
                        else if (selectedValue && selectedValue !== 'undefined') {
                            if (typeof window.fetchHistoryData === 'function') {
                                window.fetchHistoryData(selectedValue);
                            } else {
                                console.error("fetchHistoryData函数未定义");
                            }
                        } else {
                            console.error("选择器值无效:", selectedValue);
                            alert("请选择有效的时间点");
                        }
                    } else {
                        console.error("找不到历史选择器元素");
                    }
                });
            }

            // 测试API按钮
            document.getElementById('test-api-btn').addEventListener('click', async function () {
                try {
                    const response = await fetch('/api/history_times');
                    const data = await response.json();
                    console.log('API返回数据:', data);

                    // 在页面上显示结果
                    const pre = document.createElement('pre');
                    pre.style.textAlign = 'left';
                    pre.style.maxHeight = '200px';
                    pre.style.overflow = 'auto';
                    pre.style.padding = '10px';
                    pre.style.backgroundColor = '#f5f5f5';
                    pre.style.borderRadius = '5px';
                    pre.textContent = JSON.stringify(data, null, 2);

                    // 创建模态框显示
                    const modalDiv = document.createElement('div');
                    modalDiv.className = 'modal fade';
                    modalDiv.id = 'apiResultModal';
                    modalDiv.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">API返回数据</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="api-result-content"></div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modalDiv);
                    document.getElementById('api-result-content').appendChild(pre);

                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('apiResultModal'));
                    modal.show();

                } catch (e) {
                    console.error('API调用出错:', e);
                    alert('API调用出错: ' + e.message);
                }
            });

            // 刷新选择器按钮
            document.getElementById('refresh-selector-btn').addEventListener('click', function () {
                console.log('正在刷新选择器...');

                // 查找历史选择器容器
                const container = document.querySelector('.history-selector-container');
                if (!container) {
                    alert('找不到历史选择器容器!');
                    return;
                }

                // 清空容器内容
                container.innerHTML = '';

                // 创建选择器容器标记
                const containerDiv = document.createElement('div');
                containerDiv.className = 'history-selector-container';
                container.appendChild(containerDiv);

                // 创建新选择器
                const newSelector = document.createElement('select');
                newSelector.id = 'history-selector';
                newSelector.className = 'form-select form-select-sm';
                containerDiv.appendChild(newSelector);

                // 添加最新数据选项
                const latestOption = document.createElement('option');
                latestOption.value = 'latest';
                latestOption.textContent = '最新数据';
                latestOption.selected = true;
                newSelector.appendChild(latestOption);

                // 临时添加加载中选项
                const loadingOption = document.createElement('option');
                loadingOption.disabled = true;
                loadingOption.textContent = '加载中...';
                newSelector.appendChild(loadingOption);

                // 调用main.js中的函数重新获取历史时间点
                if (typeof window.fetchHistoryTimes === 'function') {
                    window.fetchHistoryTimes();
                } else {
                    console.error('fetchHistoryTimes函数未定义，可能main.js未正确加载');
                    alert('历史时间函数未找到，请刷新页面');
                }

                console.log('选择器已刷新');
            });
        });
    </script>
</body>

</html>